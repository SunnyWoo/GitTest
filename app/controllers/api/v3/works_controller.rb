=begin
@apiDefine WorksResponse
@apiSuccessExample {json} Response-Example:
  {
     "works": [
       {
          "id": 3636,
          "gid": "Z2lkOi8vY29tbWFuZC1wL1dvcmsvMzYzNg",
          "uuid": "25f6ee1a-e625-4568-b076-9736118f45ad",
          "name": "未命名",
          "user_avatar": {
            "avatar": {
              "url": "http://commandp.dev/uploads/designer/avatar/2/a496087089b2844aa25a24142d9c925c.jpg?v=1439974832"
            }
          },
          "user_id": 2,
          "order_image": {
            "thumb": "http://commandp.dev/media/BAhbCUkiI==--aafb5fdddd4a028fe76fe5f76eec0d00cd658b61.png",
            "share": "http://commandp.dev/media/BAhbCUkiI+hxxW--4ce7f67199f193ef31f616e31249949d7618304b.png",
            "sample": "http://commandp.dev/media/BAhbCUki+hxxW--0b4ef9ccc977ac4d196d384e9e69f1467cb4bbe8.png",
            "normal": "http://commandp.dev/uploads/preview/image/292/order_image2-2369-nlhgje.png?v=1444710206"
          },
          "gallery_images": [
            {
              "normal": "http://commandp.dev/uploads/preview/image/292/order_imag-2369-nlhgje.png?v=1444710206",
              "thumb": "http://commandp.dev/media/BAhbCUk==--aafb5fdddd4a028fe76fe5f76eec0d00cd658b61.png",
              "key": "order-image",
              "url": "http://commandp.dev/uploads/preview/image/292/order_image20-2369-nlhgje.png?v=1444710206",
              "image_url": "http://commandp.dev/uploads/preview/image/292/order_i-2369-nlhgje.png?v=1444710206",
              "position": 1
            },
            {
              "normal": "http://commandp.dev/uploads/preview/image/291/order_imag-2369-1bhivdz.png?v=1444710205",
              "thumb": "http://commandp.dev/media/BAhbCUk==--a8f0d7fccfc6d0b339ca6d94e2fec35b0b9416c5.png",
              "key": "r45",
              "url": "http://commandp.dev/uploads/preview/image/291/order_image20151013-2369-1bhivdz.png?v=1444710205",
              "image_url": "http://commandp.dev/uploads/preview/image/291/order_i-2369-1bhivdz.png?v=1444710205",
              "position": 2
            }
          ],
          "original_prices": {
            "TWD": 899,
            "USD": 29.95,
            "JPY": 3480,
            "HKD": 229
          },
          "prices": {
            "TWD": 899,
            "USD": 29.95,
            "JPY": 3480,
            "HKD": 229
          },
          "user_display_name": "囧哥",
          "wishlist_included": false,
          "slug": "-3be820b6-c6b9-4dad-875c-6743ba3b8f7a",
          "is_public": true,
          "user_avatars": {
            "s35": "http://commandp.dev/media/BAhb=--b57885d70f094fba4b4687d54c3dc2295d31602f.jpg",
            "s154": "http://commandp.dev/media/BAh==--33899aad6aae3967c8c66c92bbc81dc948345409.jpg"
          },
          "spec": {
            "id": 4,
            "name": "iPhone 6 手機殼",
            "description": "- 一體成型高溫塑膜\r\n- PVC硬殼保護你的手機\r\n- 熱轉印特殊防刮抗磨塑料",
            "width": 87,
            "height": 150,
            "dpi": 300,
            "background_image": null,
            "overlay_image": null,
            "padding_top": "0.0",
            "padding_right": "0.0",
            "padding_bottom": "0.0",
            "padding_left": "0.0",
            "__deprecated": "WorkSpec is not longer available"
          },
          "model": {
            "id": 4,
            "key": "iphone_6_cases",
            "name": "iPhone 6 手機殼",
            "description": "- 一體成型高溫塑膜\r\n- PVC硬殼保護你的手機\r\n- 熱轉印特殊防刮抗磨塑料",
            "prices": {
              "TWD": 899,
              "USD": 29.95,
              "JPY": 3480,
              "HKD": 229
            },
            "customized_special_prices": null,
            "design_platform": {
              "ios": true,
              "android": true,
              "website": true
            },
            "customize_platform": {
              "ios": false,
              "android": false,
              "website": true
            },
            "placeholder_image": null,
            "width": 87,
            "height": 150,
            "dpi": 300,
            "background_image": null,
            "overlay_image": null,
            "padding_top": "0.0",
            "padding_right": "0.0",
            "padding_bottom": "0.0",
            "padding_left": "0.0"
          },
          "product": {
            "id": 4,
            "key": "iphone_6_cases",
            "name": "iPhone 6 手機殼",
            "description": "- 一體成型高溫塑膜\r\n- PVC硬殼保護你的手機\r\n- 熱轉印特殊防刮抗磨塑料",
            "prices": {
              "TWD": 899,
              "USD": 29.95,
              "JPY": 3480,
              "HKD": 229
            },
            "customized_special_prices": null,
            "design_platform": {
              "ios": true,
              "android": true,
              "website": true
            },
            "customize_platform": {
              "ios": false,
              "android": false,
              "website": true
            },
            "placeholder_image": null,
            "width": 87,
            "height": 150,
            "dpi": 300,
            "background_image": null,
            "overlay_image": null,
            "padding_top": "0.0",
            "padding_right": "0.0",
            "padding_bottom": "0.0",
            "padding_left": "0.0"
          },
          "category": {
            "id": 5,
            "key": "case",
            "name": "手機殼"
          },
          "featured": false,
          "tags": [
            {
              "id": 3,
              "name": "tag_1",
              "text": "标签1"
            },
            {
              "id": 6,
              "name": "tag_2",
              "text": "标签2"
            }
          ]
        }
     ],
     "meta": {
        "request_query": {
        "query": "iphone",
        "model_id": null,
        "user_name": "囧哥",
        "tag": null,
        "sort": "random",
        "category_id": null
      },
       "current_page_count": 5,
       "current_page": 1,
       "per_page": 5,
       "total_count": 7,
       "total_pages": 2
     }
   }
=end
class Api::V3::WorksController < ApiV3Controller
  include SearchSupport
  before_action :search_work, only: :index
  before_action :doorkeeper_authorize!
  before_action :find_work, only: [:related, :show]

=begin
@api {get} /api/works Get work list
@apiUse ApiV3
@apiVersion 3.0.0
@apiGroup Works
@apiName GetWorkList
@apiParam {String} [query] key word to search
@apiParam {String} [user_name] user name
@apiParam {Integer} [category_id] category_id
@apiParam {Integer} [model_id] model id
@apiParam {String} [tag] tag text
@apiParam {String} [tag_name] tag name
@apiParam {String} [collection_name] collection name
@apiParam {String="random", "new", "popular", "price_asc", "price_desc", "recommend"} [sort] sort type
@apiParam {Integer} [page] page number
@apiParam {Integer} [per_page] works count in a single page
@apiUse WorksResponse
=end
  def index
    @request_query = params.slice(:query, :model_id, :user_name, :tag,
                                  :sort, :model_key, :category_id)
  end

=begin
@api {get} /api/works/:id/related Get the related works of a work
@apiUse ApiV3
@apiVersion 3.0.0
@apiGroup Works
@apiName GetRelatedWork
@apiParam {String} id work uuid or work slug
@apiParam {Integer} series_count the count of the same 'series' works
@apiParam {Integer} designer_count the count of the same 'designer' works
@apiParam {Integer} recommend_count the count of recommend works
@apiSuccessExample {json} Response-Example:
  {
     "related_works": {
          "series_works": [
             {
                                "id": 2,
                              "name": "work name",
                           "user_id": 3,
                         "user_name": "User Name",
                          "model_id": 3,
                        "model_name": "iPad air 2",
                             "price": 29.0,
                 "wishlist_included": false
             }
          ],
          "designer_works": [
             {
                                "id": 3,
                              "name": "work name",
                           "user_id": 1,
                         "user_name": "User Name",
                          "model_id": 4,
                        "model_name": "ProductModelName9",
                             "price": 99.9,
                 "wishlist_included": false
             }
          ],
          "recommend_works": []
     },
     "meta": {
            "series_count": 1,
          "designer_count": 1,
         "recommend_count": 0
     }
   }
=end
  def related
    fresh_when(etag: @work, last_modified: @work.updated_at)
  end

=begin
@api {get} /api/works/:uuid Get the work info
@apiUse ApiV3
@apiVersion 3.0.0
@apiGroup Works
@apiName GetWorkInfo
@apiParam {String} id work uuid or work slug
@apiSuccessExample {json} Response-Example:
 {
  "work": {
    "id": 3583,
    "gid": "Z2lkOi8vY29tbWFuZC1wL1dvcmsvMzU4Mw",
    "uuid": "78108a66-cc79-11e4-9ca2-ac87a30f9d14",
    "name": "Created By Api V3  yes",
    "user_avatar": {
      "avatar": {
        "url": "http://commandp.dev/uploads/user/avatar/1/03b1b56105cd9e39bd02a91890f29f5b.jpg?v=1454409608",
        "s35": {
          "url": "http://commandp.dev/uploads/user/avatar/1/s35_03b1b56105cd9e39bd02a91890f29f5b.jpg?v=1454409608"
        },
        "s114": {
          "url": "http://commandp.dev/uploads/user/avatar/1/s114_03b1b56105cd9e39bd02a91890f29f5b.jpg?v=1454409608"
        },
        "s154": {
          "url": "http://commandp.dev/uploads/user/avatar/1/s154_03b1b56105cd9e39bd02a91890f29f5b.jpg?v=1454409608"
        }
      }
    },
    "user_id": 1,
    "order_image": {
      "thumb": null,
      "share": null,
      "sample": null,
      "normal": null
    },
    "gallery_images": [],
    "original_prices": {
      "TWD": 899,
      "USD": 29.95,
      "JPY": 3480,
      "HKD": 229
    },
    "prices": {
      "TWD": 899,
      "USD": 29.95,
      "JPY": 3480,
      "HKD": 229
    },
    "user_display_name": "",
    "wishlist_included": false,
    "slug": "my-design-a2bbae40-5a50-479c-bd87-296503c15fe1",
    "is_public": false,
    "user_avatars": {
      "s35": "http://commandp.dev/uploads/user/avatar/1/s35_03b1b.jpg?v=1454409608",
      "s154": "http://commandp.dev/uploads/user/avatar/1/s154_03b.jpg?v=1454409608"
    },
    "spec": {
      "id": 8,
      "name": "iPhone 6 Plus 手機殼",
      "description": "- 一體成型高溫塑膜\r\n- PVC硬殼保護你的手機\r\n-密合你的手機\r\n- 熱轉印特殊防刮抗磨塑料",
      "width": 99,
      "height": 178,
      "dpi": 300,
      "background_image": null,
      "overlay_image": null,
      "padding_top": "0.0",
      "padding_right": "0.0",
      "padding_bottom": "0.0",
      "padding_left": "0.0",
      "__deprecated": "WorkSpec is not longer available"
    },
    "model": {
      "id": 8,
      "key": "iphone_6plus_cases",
      "name": "iPhone 6 Plus 手機殼",
      "description": "- 一體成型高溫塑膜\r\n- PVC硬殼保護你的手機\r\n-密合你的手機\r\n- 熱轉印特殊防刮抗磨塑料",
      "prices": {
        "TWD": 899,
        "USD": 29.95,
        "JPY": 3480,
        "HKD": 229
      },
      "customized_special_prices": null,
      "design_platform": {
        "ios": true,
        "android": true,
        "website": true
      },
      "customize_platform": {
        "ios": false,
        "android": false,
        "website": true
      },
      "placeholder_image": null,
      "width": 99,
      "height": 178,
      "dpi": 300,
      "background_image": null,
      "overlay_image": null,
      "padding_top": "0.0",
      "padding_right": "0.0",
      "padding_bottom": "0.0",
      "padding_left": "0.0"
    },
    "product": {
      "id": 8,
      "key": "iphone_6plus_cases",
      "name": "iPhone 6 Plus 手機殼",
      "description": "- 一體成型高溫塑膜\r\n- PVC硬殼保護你的手機\r\n-密合你的手機\r\n- 熱轉印特殊防刮抗磨塑料",
      "prices": {
        "TWD": 899,
        "USD": 29.95,
        "JPY": 3480,
        "HKD": 229
      },
      "customized_special_prices": null,
      "design_platform": {
        "ios": true,
        "android": true,
        "website": true
      },
      "customize_platform": {
        "ios": false,
        "android": false,
        "website": true
      },
      "placeholder_image": null,
      "width": 99,
      "height": 178,
      "dpi": 300,
      "background_image": null,
      "overlay_image": null,
      "padding_top": "0.0",
      "padding_right": "0.0",
      "padding_bottom": "0.0",
      "padding_left": "0.0"
    },
    "category": {
      "id": 5,
      "key": "case",
      "name": "手機殼"
    },
    "featured": false,
    "tags": [
      {
        "id": 3,
        "name": "tag_1",
        "text": "标签1"
      },
      {
        "id": 6,
        "name": "tag_2",
        "text": "标签2"
      }
    ]
  }
}
=end
  def show
    impressionist(@work)
    fresh_when(etag: @work, last_modified: @work.updated_at)
  end

  protected

  def find_work
    @work = Work.non_store.find_by(slug: params[:id]) || Work.find_by!(uuid: params[:id])
  end
end
